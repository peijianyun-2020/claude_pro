# -*- coding: utf-8 -*-
"""
调试脚本 - 检查飞书知识库访问权限
"""
import os
import sys
import requests
from dotenv import load_dotenv
from pathlib import Path

# 设置 Windows 控制台编码
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

# 加载环境变量
load_dotenv()

# 获取配置
app_id = os.getenv("FEISHU_APP_ID")
app_secret = os.getenv("FEISHU_APP_SECRET")
wiki_space_id = os.getenv("FEISHU_WIKI_SPACE_ID")

print("=" * 60)
print("飞书知识库调试工具")
print("=" * 60)

# 1. 获取访问令牌
print(f"\n1. 获取访问令牌...")
token_url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
token_response = requests.post(token_url, json={
    "app_id": app_id,
    "app_secret": app_secret
})
token_result = token_response.json()

if token_result.get("code") != 0:
    print(f"   失败: {token_result.get('msg')}")
    sys.exit(1)

tenant_access_token = token_result.get("tenant_access_token")
print("   成功!")

# 2. 获取可访问的知识库列表
print(f"\n2. 获取可访问的知识库列表...")
spaces_url = "https://open.feishu.cn/open-apis/wiki/v2/spaces"
headers = {
    "Authorization": f"Bearer {tenant_access_token}"
}
params = {
    "page_size": 50
}

spaces_response = requests.get(spaces_url, headers=headers, params=params)
spaces_result = spaces_response.json()

print(f"   API 响应码: {spaces_result.get('code')}")
if spaces_result.get('code') == 0:
    items = spaces_result.get('data', {}).get('items', [])
    print(f"   找到 {len(items)} 个知识库:\n")

    for i, space in enumerate(items, 1):
        print(f"   [{i}] {space.get('name')}")
        print(f"       Space ID: {space.get('space_id')}")
        print(f"       描述: {space.get('description', 'N/A')}")
        print()
else:
    print(f"   错误: {spaces_result.get('msg')}")

print(f"\n3. 查找目标知识库: {wiki_space_id}")
if spaces_result.get('code') == 0:
    items = spaces_result.get('data', {}).get('items', [])
    found = False
    for space in items:
        if space.get('space_id') == wiki_space_id:
            print(f"   找到目标知识库!")
            print(f"   名称: {space.get('name')}")
            print(f"   Space ID: {space.get('space_id')}")
            found = True

            # 获取节点列表
            print(f"\n4. 获取该知识库的节点列表...")
            nodes_url = f"https://open.feishu.cn/open-apis/wiki/v2/spaces/{wiki_space_id}/nodes"
            nodes_response = requests.get(nodes_url, headers=headers, params=params)
            nodes_result = nodes_response.json()

            print(f"   API 响应码: {nodes_result.get('code')}")
            if nodes_result.get('code') == 0:
                node_items = nodes_result.get('data', {}).get('items', [])
                print(f"   找到 {len(node_items)} 个节点:\n")
                for j, node in enumerate(node_items[:5], 1):  # 只显示前5个
                    print(f"   [{j}] {node.get('title')}")
                    print(f"       Node Token: {node.get('node_token')}")
                    print(f"       类型: {node.get('obj_type')}")
                    print()
            else:
                print(f"   错误: {nodes_result.get('msg')}")
            break

    if not found:
        print(f"   未找到知识库: {wiki_space_id}")
        print(f"\n   建议:")
        print(f"   1. 检查应用是否有访问该知识库的权限")
        print(f"   2. 检查知识库 ID 是否正确")
        print(f"   3. 在飞书开放平台添加 'wiki:wiki:read' 权限")

print("\n" + "=" * 60)
