"""
下载微信文章图片并更新Markdown
"""
import requests
from pathlib import Path
import re

# 图片URL列表
image_urls = [
    "https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe96KP8Nb1DpylponUJp55gpEsAup6LABfneZ26wFvZtJfTlOwrRx5p2TyY7y2I5OFTkpOlNr9Ubjvg/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0",
    "https://mmbiz.qpic.cn/mmbiz_png/VY8SELNGe96KP8Nb1DpylponUJp55gpEia59RfiaoMdfwCkFMiagyhGnhL6vrHWjQNOJjkchLWxWPK3SR8LzAiaSbA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=1"
]

# 保存目录
save_dir = Path(r"D:\AI\cc_pro\program\20260113_GZH-collect\wechat_articles\腾讯云开发者\images")
save_dir.mkdir(parents=True, exist_ok=True)

# 下载图片
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Referer': 'https://mp.weixin.qq.com/'
}

downloaded_files = []
for i, url in enumerate(image_urls, 1):
    try:
        print(f"下载图片 {i}/{len(image_urls)}: {url[:50]}...")
        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status()

        # 生成本地文件名
        filename = f"image_{i:03d}.png"
        filepath = save_dir / filename

        # 保存图片
        filepath.write_bytes(response.content)
        downloaded_files.append({
            'url': url,
            'local_path': f"images/{filename}",
            'filename': filename
        })
        print(f"  ✓ 已保存: {filename}")
    except Exception as e:
        print(f"  ✗ 下载失败: {e}")

print(f"\n下载完成! 共下载 {len(downloaded_files)} 张图片")

# 保存图片映射信息
import json
mapping_file = save_dir / "image_mapping.json"
with open(mapping_file, 'w', encoding='utf-8') as f:
    json.dump(downloaded_files, f, ensure_ascii=False, indent=2)

print(f"图片映射已保存: {mapping_file}")
