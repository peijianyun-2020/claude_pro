@echo off
REM 飞书多维表格 MCP 服务器安装脚本
REM 自动安装依赖并测试连接

echo ========================================
echo 飞书多维表格 MCP 服务器安装
echo ========================================
echo.

REM 切换到脚本所在目录
cd /d "%~dp0"

REM 检查 Python 是否安装
echo [1/5] 检查 Python 环境...
python --version >nul 2>&1
if errorlevel 1 (
    echo ❌ 错误：未找到 Python
    echo.
    echo 请先安装 Python 3.8 或更高版本：
    echo https://www.python.org/downloads/
    echo.
    pause
    exit /b 1
)

python --version
echo ✅ Python 环境正常
echo.

REM 检查 Python 版本
echo [2/5] 检查 Python 版本...
for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
echo Python 版本: %PYTHON_VERSION%
echo ✅ Python 版本检查完成
echo.

REM 安装依赖
echo [3/5] 安装 Python 依赖...
cd feishu-bitable-mcp

if not exist requirements.txt (
    echo ❌ 错误：未找到 requirements.txt
    pause
    exit /b 1
)

echo 正在安装依赖包...
python -m pip install -r requirements.txt --upgrade

if errorlevel 1 (
    echo.
    echo ⚠️  pip 安装失败，尝试使用清华镜像源...
    python -m pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
)

if errorlevel 1 (
    echo ❌ 错误：依赖安装失败
    echo.
    echo 请手动安装：
    echo cd feishu-bitable-mcp
    echo pip install -r requirements.txt
    echo.
    pause
    exit /b 1
)

echo ✅ 依赖安装完成
echo.

REM 检查配置
echo [4/5] 检查配置...
echo.
echo 请确保已设置以下环境变量：
echo - FEISHU_APP_ID
echo - FEISHU_APP_SECRET
echo - FEISHU_APP_TOKEN
echo - FEISHU_TABLE_ID
echo.
echo 如果未配置，请参考：docs\飞书应用创建指南.md
echo.

REM 测试连接
echo [5/5] 测试连接...
echo.
echo 正在测试飞书 API 连接...
echo.

python server.py --check

if errorlevel 1 (
    echo.
    echo ❌ 连接测试失败
    echo.
    echo 可能的原因：
    echo 1. 环境变量未配置
    echo 2. App ID 或 App Secret 错误
    echo 3. 网络连接问题
    echo 4. 飞书应用未发布
    echo.
    echo 请参考：docs\故障排查.md
    echo.
    pause
    exit /b 1
)

echo.
echo ========================================
echo ✅ 安装完成！
echo ========================================
echo.
echo 下一步：
echo.
echo 1. 配置 Claude Code MCP 服务器：
echo.
echo    方法 1 - 命令行安装：
echo    claude mcp add feishu-bitable python "%CD%\server.py"
echo.
echo    方法 2 - 配置文件：
echo    编辑 %%APPDATA%%\Claude\claude_desktop_config.json
echo    添加以下内容：
echo.
echo    {
echo      "mcpServers": {
echo        "feishu-bitable": {
echo          "command": "python",
echo          "args": ["%CD%\server.py"],
echo          "env": {
echo            "FEISHU_APP_ID": "cli_xxx",
echo            "FEISHU_APP_SECRET": "xxx",
echo            "FEISHU_APP_TOKEN": "xxx",
echo            "FEISHU_TABLE_ID": "xxx"
echo          }
echo        }
echo      }
echo    }
echo.
echo 2. 重启 Claude Code
echo.
echo 3. 在 Claude Code 中测试：
echo    获取飞书表格的字段结构
echo.
echo 详细使用说明请查看：docs\使用说明.md
echo.

pause
