"""
é£ä¹¦çŸ¥è¯†åº“ä¸Šä¼ ç¤ºä¾‹è„šæœ¬
ç”¨äºæµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
"""

import os
import sys
from pathlib import Path
from dotenv import load_dotenv
from feishu_uploader import FeishuWikiUploader


def main():
    """ä¸»å‡½æ•°"""
    # åŠ è½½ç¯å¢ƒå˜é‡
    load_dotenv()

    # æ£€æŸ¥é…ç½®
    app_id = os.getenv("FEISHU_APP_ID")
    app_secret = os.getenv("FEISHU_APP_SECRET")
    wiki_space_id = os.getenv("FEISHU_WIKI_SPACE_ID")
    node_token = os.getenv("FEISHU_WIKI_NODE_TOKEN")

    if not all([app_id, app_secret]):
        print("âŒ é”™è¯¯ï¼šè¯·å…ˆé…ç½® .env æ–‡ä»¶")
        print("\nè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š")
        print("1. å¤åˆ¶ .env.example ä¸º .env")
        print("2. å¡«å…¥ FEISHU_APP_ID")
        print("3. å¡«å…¥ FEISHU_APP_SECRET")
        print("4. å¡«å…¥ FEISHU_WIKI_SPACE_IDï¼ˆä»çŸ¥è¯†åº“ URL ä¸­è·å–ï¼‰")
        print("\nè¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒ README.md")
        sys.exit(1)

    print("=" * 60)
    print("é£ä¹¦çŸ¥è¯†åº“æ–‡ä»¶ä¸Šä¼ å·¥å…·")
    print("=" * 60)

    # åˆ›å»ºä¸Šä¼ å™¨
    print("\nğŸ“¡ æ­£åœ¨è¿æ¥é£ä¹¦...")
    uploader = FeishuWikiUploader(app_id, app_secret, wiki_space_id)

    try:
        # è·å– tokenï¼ˆéªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ï¼‰
        uploader.get_tenant_access_token()
        print("âœ… è¿æ¥æˆåŠŸï¼")
    except Exception as e:
        print(f"âŒ è¿æ¥å¤±è´¥ï¼š{str(e)}")
        print("\nè¯·æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼š")
        print("1. App ID å’Œ App Secret æ˜¯å¦æ­£ç¡®")
        print("2. åº”ç”¨æ˜¯å¦å·²å¯ç”¨")
        print("3. åº”ç”¨æƒé™æ˜¯å¦å·²æ·»åŠ ")
        sys.exit(1)

    # è·å–ç”¨æˆ·è¾“å…¥
    print("\nè¯·é€‰æ‹©ä¸Šä¼ æ–¹å¼ï¼š")
    print("1. ä¸Šä¼ å•ä¸ªæ–‡ä»¶")
    print("2. ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶å¤¹")
    print("3. ä¸Šä¼ ç¤ºä¾‹æ•°æ®ï¼ˆæ•°æ®æ–‡æ¡£æ–‡ä»¶å¤¹ï¼‰")

    choice = input("\nè¯·è¾“å…¥é€‰é¡¹ (1/2/3): ").strip()

    if choice == "1":
        # ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        file_path = input("è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: ").strip().strip('"')

        if not Path(file_path).exists():
            print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼š{file_path}")
            sys.exit(1)

        print(f"\nğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ï¼š{Path(file_path).name}")

        try:
            result = uploader.upload_file(file_path)  # è‡ªåŠ¨ä½¿ç”¨æ ¹èŠ‚ç‚¹
            print("âœ… ä¸Šä¼ æˆåŠŸï¼")
            print(f"ç»“æœï¼š{result}")
        except Exception as e:
            print(f"âŒ ä¸Šä¼ å¤±è´¥ï¼š{str(e)}")

    elif choice == "2":
        # ä¸Šä¼ æ–‡ä»¶å¤¹
        folder_path = input("è¯·è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„: ").strip().strip('"')

        if not Path(folder_path).exists() or not Path(folder_path).is_dir():
            print(f"âŒ æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼š{folder_path}")
            sys.exit(1)

        print(f"\nğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶å¤¹ï¼š{Path(folder_path).name}")

        results = uploader.upload_folder(folder_path)  # è‡ªåŠ¨ä½¿ç”¨æ ¹èŠ‚ç‚¹

        # ç»Ÿè®¡ç»“æœ
        success_count = sum(1 for r in results if r["status"] == "success")
        failed_count = len(results) - success_count

        print("\n" + "=" * 60)
        print("ä¸Šä¼ å®Œæˆï¼")
        print(f"æ€»è®¡ï¼š{len(results)} ä¸ªæ–‡ä»¶")
        print(f"âœ… æˆåŠŸï¼š{success_count} ä¸ª")
        print(f"âŒ å¤±è´¥ï¼š{failed_count} ä¸ª")

        if failed_count > 0:
            print("\nå¤±è´¥æ–‡ä»¶åˆ—è¡¨ï¼š")
            for r in results:
                if r["status"] == "failed":
                    print(f"  - {Path(r['file']).name}: {r['error']}")

    elif choice == "3":
        # ä¸Šä¼ ç¤ºä¾‹æ•°æ®
        folder_path = Path("æ•°æ®æ–‡æ¡£")

        if not folder_path.exists():
            print(f"âŒ ç¤ºä¾‹æ•°æ®æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼š{folder_path}")
            sys.exit(1)

        print(f"\nğŸ“¤ æ­£åœ¨ä¸Šä¼ ç¤ºä¾‹æ•°æ®ï¼š{folder_path.name}")

        results = uploader.upload_folder(str(folder_path))  # è‡ªåŠ¨ä½¿ç”¨æ ¹èŠ‚ç‚¹

        # ç»Ÿè®¡ç»“æœ
        success_count = sum(1 for r in results if r["status"] == "success")
        failed_count = len(results) - success_count

        print("\n" + "=" * 60)
        print("ä¸Šä¼ å®Œæˆï¼")
        print(f"æ€»è®¡ï¼š{len(results)} ä¸ªæ–‡ä»¶")
        print(f"âœ… æˆåŠŸï¼š{success_count} ä¸ª")
        print(f"âŒ å¤±è´¥ï¼š{failed_count} ä¸ª")

        if failed_count > 0:
            print("\nå¤±è´¥æ–‡ä»¶åˆ—è¡¨ï¼š")
            for r in results:
                if r["status"] == "failed":
                    print(f"  - {Path(r['file']).name}: {r['error']}")
    else:
        print("âŒ æ— æ•ˆçš„é€‰é¡¹")
        sys.exit(1)

    print("\n" + "=" * 60)
    print("æ‰“å¼€é£ä¹¦çŸ¥è¯†åº“æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶å§ï¼")
    print("=" * 60)


if __name__ == "__main__":
    main()
