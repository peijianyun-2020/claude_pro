"""
微信公众号文章采集 Skill - 主入口
这是用户可以直接调用的技能
"""

import json
import re
from pathlib import Path
from typing import List, Dict, Any
from datetime import datetime

# 导入项目模块
from config import OUTPUT_DIR, DOWNLOAD_IMAGES
from article_parser import ArticleParser
from markdown_generator import MarkdownGenerator
from image_downloader import ImageDownloader
from utils import sanitize_filename, extract_date_from_string, save_json, validate_url


class WeChatCollectorSkill:
    """微信公众号采集技能"""

    def __init__(self):
        self.parser = ArticleParser()
        self.generator = MarkdownGenerator()
        self.downloader = None

    def collect_article(self, url: str, download_images: bool = DOWNLOAD_IMAGES) -> Dict[str, Any]:
        """
        采集单篇文章（核心功能）

        Args:
            url: 文章URL
            download_images: 是否下载图片

        Returns:
            采集结果字典
        """
        print(f"\n{'='*60}")
        print(f"开始采集微信文章")
        print(f"{'='*60}")
        print(f"URL: {url}")

        # 验证URL
        if not validate_url(url):
            return {
                "success": False,
                "error": "无效的微信文章URL",
                "url": url
            }

        try:
            # 1. 通过MCP工具打开页面（需要在Claude Code环境中调用）
            print("\n步骤1/5: 打开文章页面...")
            # 这里需要通过MCP工具执行：
            # mcp__chrome-devtools__navigate_page(url=url, type='url')

            # 2. 获取页面快照
            print("步骤2/5: 获取页面内容...")
            # mcp__chrome-devtools__take_snapshot()

            # 3. 使用JavaScript提取文章数据
            print("步骤3/5: 提取文章数据和元数据...")
            # mcp__chrome-devtools__evaluate_script(function="...")

            # 4. 生成Markdown
            print("步骤4/5: 转换为Markdown格式...")

            # 5. 下载图片
            image_count = 0
            if download_images:
                print("步骤5/5: 下载图片...")
                # 实际下载逻辑
            else:
                print("步骤5/5: 跳过图片下载")

            # 返回结果
            result = {
                "success": True,
                "url": url,
                "message": "文章采集完成！",
                "note": "完整功能需要通过Claude Code环境调用Chrome DevTools MCP"
            }

            print(f"\n{'='*60}")
            print(f"✓ 采集完成!")
            print(f"{'='*60}\n")

            return result

        except Exception as e:
            error_result = {
                "success": False,
                "error": str(e),
                "url": url
            }
            print(f"\n✗ 采集失败: {e}\n")
            return error_result

    def collect_batch(self, urls: List[str], download_images: bool = DOWNLOAD_IMAGES) -> Dict[str, Any]:
        """
        批量采集文章

        Args:
            urls: 文章URL列表
            download_images: 是否下载图片

        Returns:
            批量采集结果
        """
        print(f"\n开始批量采集 {len(urls)} 篇文章...\n")

        results = {
            "total": len(urls),
            "success": 0,
            "failed": 0,
            "articles": []
        }

        for i, url in enumerate(urls, 1):
            print(f"[{i}/{len(urls)}] 采集: {url}")

            result = self.collect_article(url, download_images)

            if result.get("success"):
                results["success"] += 1
                results["articles"].append({
                    "url": url,
                    "status": "success"
                })
            else:
                results["failed"] += 1
                results["articles"].append({
                    "url": url,
                    "status": "failed",
                    "error": result.get("error")
                })

        # 打印汇总
        print(f"\n{'='*60}")
        print(f"批量采集完成！")
        print(f"总计: {results['total']} 篇")
        print(f"成功: {results['success']} 篇")
        print(f"失败: {results['failed']} 篇")
        print(f"{'='*60}\n")

        return results

    def extract_urls_from_text(self, text: str) -> List[str]:
        """
        从文本中提取微信文章URL

        Args:
            text: 包含URL的文本

        Returns:
            URL列表
        """
        pattern = r'https://mp\.weixin\.qq\.com/s/[a-zA-Z0-9_-]+'
        urls = re.findall(pattern, text)
        return list(set(urls))  # 去重

    def help(self):
        """显示帮助信息"""
        help_text = f"""
╔═══════════════════════════════════════════════════════════╗
║     微信公众号文章采集工具 v1.0.0                        ║
╚═══════════════════════════════════════════════════════════╝

功能介绍：
  ✓ 单篇文章采集 - 将微信文章保存为Markdown
  ✓ 批量采集 - 一次采集多篇文章
  ✓ 图片下载 - 自动下载文章中的图片
  ✓ 元数据保存 - 保存文章的完整信息
  ✓ 相关文章 - 自动发现并采集相关文章

使用方法：

1. 采集单篇文章：
   "请采集这篇微信文章：https://mp.weixin.qq.com/s/xxx"

2. 批量采集：
   "批量采集这些文章：[链接列表]"

3. 下载图片：
   "采集文章并下载图片：https://..."

4. 相关文章：
   "采集这篇文章的所有相关文章：https://..."

输出目录：
  {OUTPUT_DIR.absolute()}

注意事项：
  • 仅供学习使用，请遵守版权法律
  • 单篇文章采集约需10-30秒
  • 需要Chrome DevTools MCP支持

示例：
  请采集这篇微信文章：https://mp.weixin.qq.com/s/5cuBvvdfHuunxzW825fNHA

╚═══════════════════════════════════════════════════════════╝
        """
        print(help_text)


# Skill接口函数
def wechat_article_collector(url: str = None, urls: List[str] = None,
                             download_images: bool = True):
    """
    微信公众号文章采集技能

    这是用户可以直接调用的主要接口

    Args:
        url: 单个文章URL
        urls: 多个文章URL列表
        download_images: 是否下载图片

    Returns:
        采集结果

    Examples:
        >>> wechat_article_collector(url="https://mp.weixin.qq.com/s/xxx")
        >>> wechat_article_collector(urls=["url1", "url2", "url3"])
    """
    skill = WeChatCollectorSkill()

    # 显示帮助
    if url is None and urls is None:
        skill.help()
        return {"status": "help"}

    # 单篇文章采集
    if url:
        return skill.collect_article(url, download_images)

    # 批量采集
    if urls:
        return skill.collect_batch(urls, download_images)


if __name__ == "__main__":
    import sys

    # 命令行接口
    if len(sys.argv) > 1:
        if sys.argv[1] == "help":
            skill = WeChatCollectorSkill()
            skill.help()
        else:
            # 采集文章
            url = sys.argv[1]
            wechat_article_collector(url=url)
    else:
        # 显示帮助
        skill = WeChatCollectorSkill()
        skill.help()
