#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
船运货盘信息提取工具
自动读取邮件并提取船运经纪货盘信息
"""

import imaplib
import email
from email.header import decode_header
import re
import os
import json
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Optional

# Windows编码修复
if sys.platform == 'win32':
    import io
    import sys
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# 邮箱配置
IMAP_SERVER = "imap.qq.com"
IMAP_PORT = 993

# 输出目录
OUTPUT_DIR = Path(r"D:\AI\cc_pro\test_9")
EXCEL_FILE = OUTPUT_DIR / "数据提取.xlsx"


def load_env_file(env_path=None):
    """加载.env文件"""
    if env_path is None:
        current_dir = Path.cwd()
        possible_paths = [
            current_dir / '.env',
            current_dir.parent / '.env',
            Path(__file__).parent.parent.parent / '.env'
        ]

        for path in possible_paths:
            if path.exists():
                env_path = path
                break

    if env_path and env_path.exists():
        try:
            with open(env_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if not line or line.startswith('#'):
                        continue
                    if '=' in line:
                        key, value = line.split('=', 1)
                        key = key.strip()
                        value = value.strip()
                        if key not in os.environ:
                            os.environ[key] = value
            return True
        except Exception as e:
            print(f"警告: 无法加载.env文件 - {e}")
            return False
    return False


def decode_mime_words(header_value):
    """解码邮件头"""
    if header_value is None:
        return ""

    decoded_list = decode_header(header_value)
    decoded_string = ""

    for content, encoding in decoded_list:
        if isinstance(content, bytes):
            if encoding:
                try:
                    decoded_string += content.decode(encoding)
                except:
                    decoded_string += content.decode('utf-8', errors='ignore')
            else:
                decoded_string += content.decode('utf-8', errors='ignore')
        else:
            decoded_string += str(content)

    return decoded_string


def get_email_body(msg):
    """提取邮件正文"""
    body = ""

    if msg.is_multipart():
        for part in msg.walk():
            content_type = part.get_content_type()
            content_disposition = str(part.get("Content-Disposition"))

            if content_type == "text/plain" and "attachment" not in content_disposition:
                try:
                    payload = part.get_payload(decode=True)
                    charset = part.get_content_charset() or 'utf-8'
                    body += payload.decode(charset, errors='ignore')
                except:
                    pass
            elif content_type == "text/html" and "attachment" not in content_disposition and not body:
                try:
                    payload = part.get_payload(decode=True)
                    charset = part.get_content_charset() or 'utf-8'
                    body += payload.decode(charset, errors='ignore')
                except:
                    pass
    else:
        try:
            payload = msg.get_payload(decode=True)
            charset = msg.get_content_charset() or 'utf-8'
            body = payload.decode(charset, errors='ignore')
        except:
            body = str(msg.get_payload())

    return body


def is_shipping_email(subject: str, body: str) -> bool:
    """
    判断是否为船运经纪邮件

    判断依据：
    1. 主题中包含船运相关关键词
    2. 正文中包含货盘标记（A)、B)、C)等）
    3. 包含CARGO、LOAD PORT、DISCHARGE PORT等关键词
    """
    keywords = [
        'cargo', 'load port', 'discharge port', 'disport',
        'laycan', 'quantity', 'qty', 'vessel', 'shipping',
        ' freight', 'charter', 'mt', 'mts'
    ]

    subject_lower = subject.lower()
    body_lower = body.lower()

    # 检查主题
    subject_matches = sum(1 for kw in keywords if kw in subject_lower)

    # 检查正文中的货盘标记（如 A)、B)、C)）
    cargo_markers = re.findall(r'^[A-Z]\)\s*$', body, re.MULTILINE)

    # 检查正文中的关键词
    body_matches = sum(1 for kw in keywords if kw in body_lower)

    # 判断：主题有2个以上关键词，或有货盘标记，或正文有5个以上关键词
    return subject_matches >= 2 or len(cargo_markers) >= 2 or body_matches >= 5


def extract_cargo_info(email_body: str) -> List[Dict[str, str]]:
    """
    从邮件正文中提取货盘信息

    返回格式：
    [
        {
            "标记": "A",
            "货物名称": "GYPSUM IN BULK",
            "数量": "10,000 MTS",
            "装货港": "PARADIP",
            "卸货港": "MONGLA",
            "装货率": "3000 MTS PWWD SSHEX UU",
            "卸货率": "2000 MTS PWWD FSHEX UU",
            "受载期": "06TH - 10TH OCT",
            "佣金": "1.25% TTL"
        },
        ...
    ]
    """
    cargoes = []

    # 移除HTML标签
    email_body = re.sub(r'<[^>]+>', ' ', email_body)
    # 移除多余空格
    email_body = re.sub(r'\s+', ' ', email_body)
    email_body = email_body.strip()

    # 方式1: 查找带标记的货盘（A)、B)、C)等）
    pattern = r'([A-Z]\))\s*.*?(?=\n[A-Z]\)|$)'
    matches = re.findall(pattern, email_body, re.DOTALL)

    if matches:
        # 找到带标记的货盘
        cargo_sections = re.split(r'([A-Z]\))', email_body)
        current_marker = None

        for i, section in enumerate(cargo_sections):
            section = section.strip()
            if not section:
                continue

            # 检查是否是标记（如 "A)"）
            if re.match(r'^[A-Z]\)$', section):
                current_marker = section
                continue

            # 如果有当前标记，提取信息
            if current_marker:
                cargo_info = extract_single_cargo(section, current_marker)
                if cargo_info:
                    cargoes.append(cargo_info)
                current_marker = None

    # 方式2: 如果没有找到标记，尝试根据关键词提取
    if not cargoes:
        # 查找包含"CARGO"的段落
        cargo_keywords = ['CARGO', 'QTY', 'QUANTITY', 'LOAD PORT', 'DISCHARGE PORT', 'DISPORT']
        lines = email_body.split('\n')

        current_cargo = {}
        cargo_count = 0

        for line in lines:
            line = line.strip()
            if not line:
                continue

            # 检查是否包含货物关键词
            has_cargo_keyword = any(kw in line.upper() for kw in cargo_keywords)

            if has_cargo_keyword:
                # 提取字段
                if 'CARGO' in line.upper():
                    if current_cargo:  # 保存之前的货盘
                        cargoes.append(current_cargo)
                    cargo_count += 1
                    current_cargo = {"标记": chr(64 + cargo_count)}  # A, B, C...

                # 提取各个字段
                current_cargo.update(extract_fields_from_line(line))

        # 保存最后一个货盘
        if current_cargo:
            cargoes.append(current_cargo)

    return cargoes


def extract_single_cargo(text: str, marker: str = "") -> Dict[str, str]:
    """
    从文本中提取单个货盘信息
    """
    cargo_info = {
        "标记": marker.replace(")", ""),
        "货物名称": "",
        "数量": "",
        "装货港": "",
        "卸货港": "",
        "装货率": "",
        "卸货率": "",
        "受载期": "",
        "佣金": ""
    }

    # 按行处理
    lines = text.split('\n')
    for line in lines:
        line = line.strip()
        if not line:
            continue

        cargo_info.update(extract_fields_from_line(line))

    return cargo_info


def extract_fields_from_line(line: str) -> Dict[str, str]:
    """
    从单行文本中提取货盘字段
    """
    fields = {}
    line_upper = line.upper()

    # 货物名称 (CARGO)
    cargo_match = re.search(r'CARGO\s*[:\-]?\s*(.*?)(?:\n|QTY|LOAD|DISCHARGE|$)', line_upper, re.IGNORECASE)
    if cargo_match:
        cargo_name = cargo_match.group(1).strip()
        # 提取原始大小写的货物名称
        cargo_match_orig = re.search(r'CARGO\s*[:\-]?\s*(.*?)(?:\n|QTY|LOAD|DISCHARGE|$)', line, re.IGNORECASE)
        if cargo_match_orig:
            cargo_name = cargo_match_orig.group(1).strip()
        fields["货物名称"] = cargo_name

    # 数量 (QTY/QUANTITY)
    qty_match = re.search(r'(?:QTY|QUANTITY)\s*[:\-]?\s*([^\n]+?)(?:\n|LOAD|DISCHARGE|LAYCAN|COMM|$)', line, re.IGNORECASE)
    if qty_match:
        fields["数量"] = qty_match.group(1).strip()

    # 装货港 (LOAD PORT)
    load_port_match = re.search(r'LOAD PORT\s*[:\-]?\s*([^\n]+?)(?:\n|DISCHARGE|DISPORT|LAYCAN|COMM|$)', line, re.IGNORECASE)
    if load_port_match:
        fields["装货港"] = load_port_match.group(1).strip()

    # 卸货港 (DISCHARGE PORT/DISPORT)
    discharge_match = re.search(r'(?:DISCHARGE PORT|DISPORT)\s*[:\-]?\s*([^\n]+?)(?:\n|LOAD|LAYCAN|COMM|RATE|$)', line, re.IGNORECASE)
    if discharge_match:
        fields["卸货港"] = discharge_match.group(1).strip()

    # 装货率 (LOAD RATE)
    load_rate_match = re.search(r'LOAD RATE\s*[:\-]?\s*([^\n]+?)(?:\n|DISCHARGE|DISRATE|LAYCAN|COMM|$)', line, re.IGNORECASE)
    if load_rate_match:
        fields["装货率"] = load_rate_match.group(1).strip()

    # 卸货率 (DISCHARGE RATE/DISRATE)
    discharge_rate_match = re.search(r'(?:DISCHARGE RATE|DISRATE)\s*[:\-]?\s*([^\n]+?)(?:\n|LOAD|LAYCAN|COMM|$)', line, re.IGNORECASE)
    if discharge_rate_match:
        fields["卸货率"] = discharge_rate_match.group(1).strip()

    # 受载期 (LAYCAN)
    laycan_match = re.search(r'LAYCAN\s*[:\-]?\s*([^\n]+?)(?:\n|COMM|RATE|$)', line, re.IGNORECASE)
    if laycan_match:
        fields["受载期"] = laycan_match.group(1).strip()

    # 佣金 (COMM)
    comm_match = re.search(r'COMM\s*[:\-]?\s*([^\n]+?)(?:\n|AS|$)', line, re.IGNORECASE)
    if comm_match:
        fields["佣金"] = comm_match.group(1).strip()

    return fields


def read_emails_and_extract_cargo(email_address: str, auth_code: str, count: int = 50) -> List[Dict]:
    """
    读取邮件并提取货盘信息

    返回格式：
    [
        {
            "邮件主题": "...",
            "发件人": "...",
            "日期": "...",
            "货盘信息": [
                {
                    "标记": "A",
                    "货物名称": "...",
                    ...
                }
            ]
        },
        ...
    ]
    """
    try:
        print(f"正在连接到 {IMAP_SERVER}:{IMAP_PORT}...")
        mail = imaplib.IMAP4_SSL(IMAP_SERVER, IMAP_PORT)

        print(f"正在登录 {email_address}...")
        mail.login(email_address, auth_code)

        mail.select("INBOX")
        print(f"已选择收件箱")

        print(f"正在搜索邮件...")
        status, messages = mail.search(None, "ALL")

        if status != "OK":
            print("搜索邮件失败")
            return []

        email_ids = messages[0].split()
        total_emails = len(email_ids)
        print(f"总共找到 {total_emails} 封邮件")

        # 获取最近的N封邮件
        recent_ids = email_ids[-count:] if total_emails > count else email_ids
        print(f"正在读取最近 {len(recent_ids)} 封邮件...\n")

        results = []
        shipping_email_count = 0
        cargo_total_count = 0

        # 倒序遍历（最新的在前）
        for idx, email_id in enumerate(reversed(recent_ids), 1):
            status, msg_data = mail.fetch(email_id, "(RFC822)")

            if status != "OK":
                continue

            raw_email = msg_data[0][1]
            msg = email.message_from_bytes(raw_email)

            # 提取邮件信息
            subject = decode_mime_words(msg.get("Subject"))
            from_addr = decode_mime_words(msg.get("From"))
            date = msg.get("Date")
            body = get_email_body(msg)

            # 判断是否为船运邮件
            if is_shipping_email(subject, body):
                shipping_email_count += 1

                # 提取货盘信息
                cargoes = extract_cargo_info(body)

                if cargoes:
                    cargo_total_count += len(cargoes)

                    result = {
                        "邮件主题": subject,
                        "发件人": from_addr,
                        "日期": date,
                        "货盘信息": cargoes
                    }
                    results.append(result)

                    print(f"[{idx}] 发现货盘: {len(cargoes)}个 - {subject[:50]}...")
                else:
                    print(f"[{idx}] 船运邮件但未提取到货盘: {subject[:50]}...")

        mail.close()
        mail.logout()

        print(f"\n{'='*80}")
        print(f"扫描完成:")
        print(f"  - 读取邮件: {len(recent_ids)} 封")
        print(f"  - 船运邮件: {shipping_email_count} 封")
        print(f"  - 提取货盘: {cargo_total_count} 个")
        print(f"{'='*80}\n")

        return results

    except imaplib.IMAP4.error as e:
        print(f"IMAP错误: {e}")
        return []
    except Exception as e:
        print(f"发生错误: {e}")
        import traceback
        traceback.print_exc()
        return []


def save_to_excel(cargo_data: List[Dict], excel_path: Path):
    """
    保存货盘信息到Excel文件

    自动去重，添加来源信息
    """
    try:
        import openpyxl
        from openpyxl import Workbook
        from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
    except ImportError:
        print("错误: 需要安装openpyxl库")
        print("请运行: pip install openpyxl")
        return False

    # 创建目录
    excel_path.parent.mkdir(parents=True, exist_ok=True)

    # 检查文件是否存在
    if excel_path.exists():
        # 读取现有数据
        print(f"读取现有Excel文件: {excel_path}")
        wb = openpyxl.load_workbook(excel_path)
        ws = wb.active

        # 读取现有数据用于去重
        existing_data = []
        for row in ws.iter_rows(min_row=2, values_only=True):
            if row[0]:  # 如果有日期
                existing_data.append({
                    "日期": row[0],
                    "发件人": row[1],
                    "标记": row[2],
                    "货物名称": row[3],
                    "数量": row[4],
                    "装货港": row[5],
                    "卸货港": row[6],
                    "装货率": row[7],
                    "卸货率": row[8],
                    "受载期": row[9],
                    "佣金": row[10],
                    "邮件主题": row[11] if len(row) > 11 else ""
                })

        # 找到最后一行
        last_row = ws.max_row + 1
    else:
        # 创建新工作簿
        wb = Workbook()
        ws = wb.active
        ws.title = "货盘信息"

        # 创建标题行
        headers = [
            "邮件日期", "发件人", "标记", "货物名称", "数量",
            "装货港", "卸货港", "装货率", "卸货率", "受载期", "佣金", "邮件主题"
        ]

        # 设置标题样式
        header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
        header_font = Font(bold=True, color="FFFFFF", size=11)
        border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )

        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.border = border

        # 设置列宽
        column_widths = [20, 30, 8, 25, 15, 20, 20, 30, 30, 15, 10, 40]
        for col, width in enumerate(column_widths, 1):
            ws.column_dimensions[openpyxl.utils.get_column_letter(col)].width = width

        existing_data = []
        last_row = 2

    # 添加新数据
    new_count = 0
    duplicate_count = 0

    border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )

    for email_info in cargo_data:
        email_date = email_info["日期"]
        email_from = email_info["发件人"]
        email_subject = email_info["邮件主题"]

        for cargo in email_info["货盘信息"]:
            # 创建唯一标识（用于去重）
            unique_id = f"{email_date}_{email_from}_{cargo['标记']}_{cargo['货物名称'][:20]}"

            # 检查是否重复
            is_duplicate = False
            for existing in existing_data:
                if (existing["日期"] == email_date and
                    existing["发件人"] == email_from and
                    existing["标记"] == cargo["标记"] and
                    existing["货物名称"] == cargo["货物名称"]):
                    is_duplicate = True
                    break

            if is_duplicate:
                duplicate_count += 1
                continue

            # 添加新行
            row_data = [
                email_date,
                email_from,
                cargo["标记"],
                cargo["货物名称"],
                cargo["数量"],
                cargo["装货港"],
                cargo["卸货港"],
                cargo["装货率"],
                cargo["卸货率"],
                cargo["受载期"],
                cargo["佣金"],
                email_subject
            ]

            for col, value in enumerate(row_data, 1):
                cell = ws.cell(row=last_row, column=col, value=value)
                cell.alignment = Alignment(horizontal='left', vertical='center', wrap_text=True)
                cell.border = border

            last_row += 1
            new_count += 1

            # 添加到现有数据列表
            existing_data.append({
                "日期": email_date,
                "发件人": email_from,
                "标记": cargo["标记"],
                "货物名称": cargo["货物名称"],
                "数量": cargo["数量"],
                "装货港": cargo["装货港"],
                "卸货港": cargo["卸货港"],
                "装货率": cargo["装货率"],
                "卸货率": cargo["卸货率"],
                "受载期": cargo["受载期"],
                "佣金": cargo["佣金"],
                "邮件主题": email_subject
            })

    # 保存文件
    wb.save(excel_path)

    print(f"\n{'='*80}")
    print(f"Excel文件已保存: {excel_path}")
    print(f"  - 新增货盘: {new_count} 个")
    print(f"  - 重复货盘: {duplicate_count} 个 (已跳过)")
    print(f"  - 总记录数: {last_row - 1} 行")
    print(f"{'='*80}\n")

    return True


def main():
    """主函数"""
    # 加载环境变量
    env_loaded = load_env_file()
    if env_loaded:
        print("已加载.env配置文件")

    # 读取配置
    email_address = os.getenv("QQMAIL_EMAIL")
    auth_code = os.getenv("QQMAIL_AUTH_CODE")

    if not email_address or not auth_code:
        print("错误: 未找到邮箱配置")
        print("请确保.env文件中配置了QQMAIL_EMAIL和QQMAIL_AUTH_CODE")
        return

    # 读取邮件数量
    count = 50

    print(f"\n{'='*80}")
    print(f"船运货盘信息提取工具")
    print(f"{'='*80}\n")

    # 读取邮件并提取货盘
    results = read_emails_and_extract_cargo(email_address, auth_code, count)

    if results:
        # 保存到Excel
        success = save_to_excel(results, EXCEL_FILE)

        if success:
            print("✅ 完成！")
        else:
            print("❌ 保存失败")
    else:
        print("未找到货盘信息")


if __name__ == "__main__":
    main()
