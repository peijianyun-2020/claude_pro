"""
å—æ–¹åŒºåŸŸç”µåŠ›ç°è´§ä»·æ ¼æ•°æ®å¤„ç†è„šæœ¬
ä»äº¤æ˜“ç³»ç»ŸAPIæ•°æ®ç”Ÿæˆæ ‡å‡†æ ¼å¼çš„CSVæ–‡ä»¶
"""

import csv
import json
import sys
from pathlib import Path
from datetime import datetime

# æ•°æ®ç›®å½•é…ç½®
DATA_DIR = Path(r"D:\AI\cc_pro\ç°è´§ä»·æ ¼é‡‡é›†")

# åœ°åŒºä»£ç æ˜ å°„
REGION_MAP = {
    "00": "å…¨åŒºåŸŸ",
    "02": "å¹¿ä¸œ",
    "03": "å¹¿è¥¿",
    "04": "äº‘å—",
    "05": "è´µå·",
    "06": "æµ·å—"
}


def parse_date(date_str):
    """è§£ææ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šç§æ ¼å¼"""
    date_str = date_str.strip().replace("-", "").replace("/", "")

    if len(date_str) == 8:
        return datetime.strptime(date_str, "%Y%m%d").strftime("%Y-%m-%d")
    elif len(date_str) == 10:
        return datetime.strptime(date_str, "%Y-%m-%d").strftime("%Y-%m-%d")
    else:
        raise ValueError(f"æ— æ³•è§£ææ—¥æœŸ: {date_str}")


def save_price_data(api_data, target_date, data_type="dayahead"):
    """
    ä¿å­˜ä»·æ ¼æ•°æ®ä¸ºCSV

    å‚æ•°:
        api_data: APIè¿”å›çš„å®Œæ•´JSONæ•°æ®
        target_date: ç›®æ ‡æ—¥æœŸ (YYYY-MM-DD æˆ– YYYYMMDD)
        data_type: æ•°æ®ç±»å‹ ("dayahead"=æ—¥å‰ æˆ– "realtime"=å®æ—¶)
    """
    # è§£ææ—¥æœŸ
    date_formatted = parse_date(target_date)

    # åˆ›å»ºCSVæ•°æ®
    csv_data = []
    headers = ["æ—¶é—´"] + list(REGION_MAP.values())
    csv_data.append(headers)

    # ç”Ÿæˆ24ä¸ªå°æ—¶çš„æ•°æ®
    for hour in range(24):
        time_str = f"{hour:02d}:00"
        row = [time_str]

        for exchange_code in REGION_MAP.keys():
            region_data = next(
                (item for item in api_data["data"]
                 if item["exchange"] == exchange_code),
                None
            )

            if region_data:
                price_key = f"price{hour:02d}00"
                price = region_data.get(price_key, "0")
                row.append(price)
            else:
                row.append("0")

        csv_data.append(row)

    # ç”Ÿæˆæ–‡ä»¶å
    date_short = date_formatted.replace("-", "")
    type_label = "å®æ—¶ä»·æ ¼" if data_type == "realtime" else "æ—¥å‰ä»·æ ¼"
    csv_filename = f"{type_label}_{date_short}.csv"
    csv_path = DATA_DIR / csv_filename

    # ä¿å­˜æ–‡ä»¶
    with open(csv_path, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerows(csv_data)

    print(f"\nâœ… æ•°æ®å·²ä¿å­˜: {csv_path}")
    print(f"ğŸ“Š è®°å½•æ•°: {len(csv_data)-1} è¡Œ")
    print(f"ğŸ“… æ—¥æœŸ: {date_formatted}")
    print(f"ğŸ·ï¸  ç±»å‹: {type_label}")

    return csv_path


def load_api_data_from_file(file_path):
    """ä»JSONæ–‡ä»¶åŠ è½½APIæ•°æ®"""
    with open(file_path, 'r', encoding='utf-8') as f:
        return json.load(f)


def interactive_mode():
    """äº¤äº’å¼æ¨¡å¼"""
    print("\n" + "="*50)
    print("å—æ–¹åŒºåŸŸç”µåŠ›ç°è´§ä»·æ ¼æ•°æ®å¤„ç†å·¥å…·")
    print("="*50)

    # è¾“å…¥æ—¥æœŸ
    date_input = input("\nè¯·è¾“å…¥ç›®æ ‡æ—¥æœŸ (æ ¼å¼: YYYYMMDD æˆ– YYYY-MM-DD): ").strip()
    if not date_input:
        print("âŒ æ—¥æœŸä¸èƒ½ä¸ºç©º")
        return

    # è¾“å…¥æ•°æ®ç±»å‹
    print("\nè¯·é€‰æ‹©æ•°æ®ç±»å‹:")
    print("  1. æ—¥å‰æ•°æ®")
    print("  2. å®æ—¶æ•°æ®")
    type_input = input("è¯·è¾“å…¥é€‰é¡¹ (1 æˆ– 2): ").strip()

    if type_input == "1":
        data_type = "dayahead"
    elif type_input == "2":
        data_type = "realtime"
    else:
        print("âŒ æ— æ•ˆçš„é€‰é¡¹")
        return

    # è¾“å…¥JSONæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    json_path = input("\nè¯·è¾“å…¥APIæ•°æ®JSONæ–‡ä»¶è·¯å¾„ (ç•™ç©ºåˆ™ä»ç²˜è´´æ¿è¯»å–): ").strip()

    if json_path:
        try:
            api_data = load_api_data_from_file(json_path)
        except Exception as e:
            print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return
    else:
        print("\nè¯·å°†APIè¿”å›çš„JSONæ•°æ®ç²˜è´´åˆ°è„šæœ¬ä¸­çš„ DEFAULT_API_DATA å˜é‡")
        print("æˆ–è€…å°†JSONæ•°æ®ä¿å­˜ä¸ºæ–‡ä»¶åé‡æ–°è¿è¡Œè„šæœ¬")
        return

    # ä¿å­˜æ•°æ®
    try:
        save_price_data(api_data, date_input, data_type)
    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥: {e}")
        return


def main():
    """ä¸»å‡½æ•°"""
    if len(sys.argv) == 1:
        # æ— å‚æ•°ï¼Œè¿›å…¥äº¤äº’æ¨¡å¼
        interactive_mode()
    else:
        print("\nä½¿ç”¨æ–¹æ³•:")
        print("1. äº¤äº’æ¨¡å¼: python process_spot_price.py")
        print("2. å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆå¼€å‘ä¸­ï¼‰")
        print("\nå½“å‰ä»…æ”¯æŒäº¤äº’æ¨¡å¼")


if __name__ == "__main__":
    main()
