#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
提取第一封货运邮件的完整内容
"""

import imaplib
import email
from email.header import decode_header
import os
import json
from pathlib import Path

def load_env_file():
    """加载.env文件"""
    env_paths = [
        Path.cwd() / '.env',
        Path.cwd().parent / '.env',
        Path(__file__).parent / '.env'
    ]

    for env_path in env_paths:
        if env_path.exists():
            with open(env_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        if key.strip() not in os.environ:
                            os.environ[key.strip()] = value.strip()
            return True
    return False

def decode_mime_words(header_value):
    """解码邮件头"""
    if header_value is None:
        return ""

    decoded_list = decode_header(header_value)
    decoded_string = ""

    for content, encoding in decoded_list:
        if isinstance(content, bytes):
            if encoding:
                try:
                    decoded_string += content.decode(encoding)
                except:
                    decoded_string += content.decode('utf-8', errors='ignore')
            else:
                decoded_string += content.decode('utf-8', errors='ignore')
        else:
            decoded_string += str(content)

    return decoded_string

def get_email_body(msg):
    """提取邮件正文"""
    body = ""

    if msg.is_multipart():
        for part in msg.walk():
            content_type = part.get_content_type()
            content_disposition = str(part.get("Content-Disposition"))

            if content_type == "text/plain" and "attachment" not in content_disposition:
                try:
                    payload = part.get_payload(decode=True)
                    charset = part.get_content_charset() or 'utf-8'
                    body += payload.decode(charset, errors='ignore')
                except:
                    pass
            elif content_type == "text/html" and "attachment" not in content_disposition and not body:
                try:
                    payload = part.get_payload(decode=True)
                    charset = part.get_content_charset() or 'utf-8'
                    body += payload.decode(charset, errors='ignore')
                except:
                    pass
    else:
        try:
            payload = msg.get_payload(decode=True)
            charset = msg.get_content_charset() or 'utf-8'
            body = payload.decode(charset, errors='ignore')
        except:
            body = str(msg.get_payload())

    return body

# 加载环境变量
load_env_file()

email_address = os.getenv("QQMAIL_EMAIL")
auth_code = os.getenv("QQMAIL_AUTH_CODE")

# 连接到IMAP服务器
print("连接到QQ邮箱...")
mail = imaplib.IMAP4_SSL("imap.qq.com", 993)
mail.login(email_address, auth_code)
mail.select("INBOX")

# 获取第一封邮件（最新的）
status, messages = mail.search(None, "ALL")
email_ids = messages[0].split()
latest_id = email_ids[-1]  # 最新的邮件

# 获取邮件
status, msg_data = mail.fetch(latest_id, "(RFC822)")
raw_email = msg_data[0][1]
msg = email.message_from_bytes(raw_email)

# 提取信息
email_data = {
    "subject": decode_mime_words(msg.get("Subject")),
    "from": decode_mime_words(msg.get("From")),
    "to": decode_mime_words(msg.get("To")),
    "date": msg.get("Date"),
    "body": get_email_body(msg)
}

# 保存到文件
output_file = Path("cargo_email_full.json")
with open(output_file, 'w', encoding='utf-8') as f:
    json.dump(email_data, f, ensure_ascii=False, indent=2)

print(f"\n邮件已保存到: {output_file.absolute()}")
print(f"\n邮件正文长度: {len(email_data['body'])} 字符")
print("\n" + "="*80)
print("邮件正文预览:")
print("="*80)
print(email_data['body'][:3000])
print("\n..." + f"\n(总长度: {len(email_data['body'])} 字符)")

mail.close()
mail.logout()
