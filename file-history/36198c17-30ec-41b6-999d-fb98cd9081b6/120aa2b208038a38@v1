#!/usr/bin/env python3
"""
飞书多维表格 MCP 服务器
提供工具接口供 Claude Code 调用，实现数据写入飞书多维表格
"""

import sys
import json
import os
from typing import Any, Optional
from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent

# 导入飞书客户端
from feishu_client import FeishuClient

# 创建 MCP 服务器实例
server = Server("feishu-bitable-server")

# 全局客户端实例（延迟初始化）
_client: Optional[FeishuClient] = None


def get_client() -> FeishuClient:
    """获取飞书客户端实例（延迟初始化）"""
    global _client
    if _client is None:
        _client = FeishuClient()
    return _client


@server.list_tools()
async def list_tools() -> list[Tool]:
    """列出所有可用的工具"""
    return [
        Tool(
            name="write_record",
            description="向飞书多维表格写入单条记录。适用于写入单条社交媒体数据（小红书笔记、抖音视频等）或监控数据。",
            inputSchema={
                "type": "object",
                "properties": {
                    "fields": {
                        "type": "object",
                        "description": "记录字段数据，JSON 对象格式。例如：{\"title\": \"标题\", \"author\": \"作者\", \"likes\": 123, \"note_id\": \"唯一ID\"}"
                    }
                },
                "required": ["fields"]
            }
        ),
        Tool(
            name="upsert_record",
            description="追加或更新记录（推荐使用）。根据唯一字段判断记录是否存在，存在则更新，不存在则创建。适用于需要去重的数据写入。",
            inputSchema={
                "type": "object",
                "properties": {
                    "fields": {
                        "type": "object",
                        "description": "记录字段数据，JSON 对象格式。必须包含唯一标识字段（如 note_id、url 等）。"
                    },
                    "unique_field": {
                        "type": "string",
                        "description": "用于判断唯一性的字段名称，默认为 \"note_id\"。常见选项：note_id（笔记ID）、url（链接）、title（标题）等。",
                        "default": "note_id"
                    }
                },
                "required": ["fields"]
            }
        ),
        Tool(
            name="batch_write_records",
            description="批量写入多条记录到飞书多维表格。适用于一次性写入大量数据。",
            inputSchema={
                "type": "object",
                "properties": {
                    "records": {
                        "type": "array",
                        "description": "记录列表，每条记录都是字段数据的 JSON 对象。例如：[{\"title\": \"标题1\", \"likes\": 100}, {\"title\": \"标题2\", \"likes\": 200}]",
                        "items": {
                            "type": "object"
                        }
                    }
                },
                "required": ["records"]
            }
        ),
        Tool(
            name="find_record",
            description="根据字段值查找记录。用于检查某条记录是否已存在。",
            inputSchema={
                "type": "object",
                "properties": {
                    "field_name": {
                        "type": "string",
                        "description": "要查找的字段名称，如 \"note_id\"、\"url\"、\"title\" 等。"
                    },
                    "field_value": {
                        "type": "string",
                        "description": "要查找的字段值。"
                    }
                },
                "required": ["field_name", "field_value"]
            }
        ),
        Tool(
            name="get_table_schema",
            description="获取飞书多维表格的字段结构信息。返回表格中所有字段的名称、类型等信息。",
            inputSchema={
                "type": "object",
                "properties": {},
                "required": []
            }
        )
    ]


@server.call_tool()
async def call_tool(name: str, arguments: Any) -> list[TextContent]:
    """处理工具调用"""

    try:
        client = get_client()

        if name == "write_record":
            # 写入单条记录
            fields = arguments.get("fields")
            if not fields:
                return [TextContent(
                    type="text",
                    text="错误：缺少 fields 参数"
                )]

            record = client.create_record(fields)
            result = {
                "success": True,
                "action": "created",
                "record_id": record.get("record_id"),
                "message": "✅ 记录创建成功"
            }
            return [TextContent(
                type="text",
                text=json.dumps(result, ensure_ascii=False, indent=2)
            )]

        elif name == "upsert_record":
            # 追加或更新记录
            fields = arguments.get("fields")
            unique_field = arguments.get("unique_field", "note_id")

            if not fields:
                return [TextContent(
                    type="text",
                    text="错误：缺少 fields 参数"
                )]

            result = client.upsert_record(fields, unique_field)
            response = {
                "success": True,
                "action": result["action"],  # "created" 或 "updated"
                "record_id": result["record"].get("record_id"),
                "message": f"✅ 记录{result['action']}成功"
            }
            return [TextContent(
                type="text",
                text=json.dumps(response, ensure_ascii=False, indent=2)
            )]

        elif name == "batch_write_records":
            # 批量写入记录
            records = arguments.get("records")
            if not records:
                return [TextContent(
                    type="text",
                    text="错误：缺少 records 参数"
                )]

            created_records = client.batch_create_records(records)
            result = {
                "success": True,
                "action": "batch_created",
                "count": len(created_records),
                "record_ids": [r.get("record_id") for r in created_records],
                "message": f"✅ 成功创建 {len(created_records)} 条记录"
            }
            return [TextContent(
                type="text",
                text=json.dumps(result, ensure_ascii=False, indent=2)
            )]

        elif name == "find_record":
            # 查找记录
            field_name = arguments.get("field_name")
            field_value = arguments.get("field_value")

            if not field_name or field_value is None:
                return [TextContent(
                    type="text",
                    text="错误：缺少 field_name 或 field_value 参数"
                )]

            record = client.find_record(field_name, field_value)

            if record:
                result = {
                    "success": True,
                    "found": True,
                    "record": record,
                    "message": "✅ 找到记录"
                }
            else:
                result = {
                    "success": True,
                    "found": False,
                    "message": "ℹ️ 未找到匹配的记录"
                }

            return [TextContent(
                type="text",
                text=json.dumps(result, ensure_ascii=False, indent=2)
            )]

        elif name == "get_table_schema":
            # 获取表格结构
            schema = client.get_table_schema()
            fields = schema.get("items", [])

            field_info = []
            for field in fields:
                field_info.append({
                    "field_name": field.get("field_name"),
                    "type": field.get("type"),
                    "description": field.get("description", ""),
                    "options": field.get("options", [])
                })

            result = {
                "success": True,
                "field_count": len(field_info),
                "fields": field_info,
                "message": f"✅ 表格共有 {len(field_info)} 个字段"
            }

            return [TextContent(
                type="text",
                text=json.dumps(result, ensure_ascii=False, indent=2)
            )]

        else:
            return [TextContent(
                type="text",
                text=f"错误：未知的工具名称 '{name}'"
            )]

    except ValueError as e:
        # 配置错误
        return [TextContent(
            type="text",
            text=f"❌ 配置错误：{str(e)}\n\n请检查环境变量配置：\n- FEISHU_APP_ID\n- FEISHU_APP_SECRET\n- FEISHU_APP_TOKEN\n- FEISHU_TABLE_ID"
        )]

    except Exception as e:
        # 其他错误
        return [TextContent(
            type="text",
            text=f"❌ 操作失败：{str(e)}"
        )]


async def main():
    """启动 MCP 服务器"""
    async with stdio_server() as (read_stream, write_stream):
        await server.run(
            read_stream,
            write_stream,
            server.create_initialization_options()
        )


if __name__ == "__main__":
    # 直接运行时，输出配置提示
    if len(sys.argv) > 1 and sys.argv[1] == "--check":
        print("检查配置...")
        try:
            client = FeishuClient()
            print("✅ FEISHU_APP_ID: 已配置")
            print("✅ FEISHU_APP_SECRET: 已配置")

            if os.getenv("FEISHU_APP_TOKEN"):
                print("✅ FEISHU_APP_TOKEN: 已配置")
            else:
                print("⚠️  FEISHU_APP_TOKEN: 未配置（写入数据时需要）")

            if os.getenv("FEISHU_TABLE_ID"):
                print("✅ FEISHU_TABLE_ID: 已配置")
            else:
                print("⚠️  FEISHU_TABLE_ID: 未配置（写入数据时需要）")

            print("\n尝试连接飞书 API...")
            schema = client.get_table_schema()
            print(f"✅ 成功连接到飞书多维表格！")
            print(f"   字段数量: {len(schema.get('items', []))}")

        except Exception as e:
            print(f"❌ 配置检查失败: {str(e)}")
    else:
        # 启动 MCP 服务器
        import asyncio
        asyncio.run(main())
