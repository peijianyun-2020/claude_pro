"""
工具函数
"""
import os
import re
import json
from pathlib import Path
from datetime import datetime
from typing import Any, Dict, List


def sanitize_filename(filename: str) -> str:
    """
    清理文件名，移除非法字符

    Args:
        filename: 原始文件名

    Returns:
        清理后的文件名
    """
    # 移除或替换Windows文件名中的非法字符
    illegal_chars = ['<', '>', ':', '"', '/', '\\', '|', '?', '*']
    for char in illegal_chars:
        filename = filename.replace(char, '_')

    # 移除前后空格
    filename = filename.strip()

    # 限制文件名长度
    if len(filename) > 200:
        filename = filename[:200]

    return filename


def extract_date_from_string(date_str: str) -> str:
    """
    从字符串中提取日期

    Args:
        date_str: 包含日期的字符串

    Returns:
        格式化的日期字符串 (YYYY-MM-DD)
    """
    # 尝试匹配中文日期格式
    match = re.search(r'(\d{4})年(\d{1,2})月(\d{1,2})日', date_str)
    if match:
        year, month, day = match.groups()
        return f"{year}-{month.zfill(2)}-{day.zfill(2)}"

    # 尝试匹配标准日期格式
    match = re.search(r'(\d{4})-(\d{1,2})-(\d{1,2})', date_str)
    if match:
        year, month, day = match.groups()
        return f"{year}-{month.zfill(2)}-{day.zfill(2)}"

    # 如果无法提取，返回当前日期
    return datetime.now().strftime("%Y-%m-%d")


def save_json(data: Any, filepath: str) -> bool:
    """
    保存JSON文件

    Args:
        data: 要保存的数据
        filepath: 文件路径

    Returns:
        是否成功
    """
    try:
        Path(filepath).parent.mkdir(parents=True, exist_ok=True)
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        print(f"保存JSON失败: {e}")
        return False


def load_json(filepath: str) -> Any:
    """
    加载JSON文件

    Args:
        filepath: 文件路径

    Returns:
        JSON数据
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"加载JSON失败: {e}")
        return None


def format_file_size(size_bytes: int) -> str:
    """
    格式化文件大小

    Args:
        size_bytes: 字节数

    Returns:
        格式化后的字符串
    """
    for unit in ['B', 'KB', 'MB', 'GB']:
        if size_bytes < 1024:
            return f"{size_bytes:.2f} {unit}"
        size_bytes /= 1024
    return f"{size_bytes:.2f} TB"


def print_progress(current: int, total: int, prefix: str = ""):
    """
    打印进度条

    Args:
        current: 当前进度
        total: 总数
        prefix: 前缀文本
    """
    percent = (current / total) * 100
    bar_length = 50
    filled = int(bar_length * current / total)
    bar = '█' * filled + '-' * (bar_length - filled)
    print(f'\r{prefix} [{bar}] {percent:.1f}% ({current}/{total})', end='', flush=True)

    if current == total:
        print()  # 完成后换行


def validate_url(url: str) -> bool:
    """
    验证是否为有效的微信文章URL

    Args:
        url: 待验证的URL

    Returns:
        是否有效
    """
    pattern = r'https://mp\.weixin\.qq\.com/s/[a-zA-Z0-9_-]+'
    return bool(re.match(pattern, url))


def extract_links_from_file(filepath: str) -> List[str]:
    """
    从文件中提取链接

    Args:
        filepath: 文件路径

    Returns:
        链接列表
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            lines = f.readlines()

        links = []
        for line in lines:
            line = line.strip()
            if line and not line.startswith('#'):  # 跳过空行和注释
                # 提取URL（如果行中包含URL）
                url_match = re.search(r'https://mp\.weixin\.qq\.com/s/[a-zA-Z0-9_-]+', line)
                if url_match:
                    links.append(url_match.group(0))

        return links
    except Exception as e:
        print(f"读取文件失败: {e}")
        return []


def create_index_file(articles: List[Dict], output_dir: Path):
    """
    创建索引文件

    Args:
        articles: 文章列表
        output_dir: 输出目录
    """
    index_file = output_dir / "index.json"

    index_data = {
        'created_at': datetime.now().isoformat(),
        'total_articles': len(articles),
        'articles': articles
    }

    save_json(index_data, str(index_file))
    print(f"索引文件已保存: {index_file}")
