import json
import csv
from datetime import datetime

# åœ°åŒºä»£ç æ˜ å°„
REGION_MAP = {
    "00": "å…¨åŒºåŸŸ",
    "02": "å¹¿ä¸œ",
    "03": "å¹¿è¥¿",
    "04": "äº‘å—",
    "05": "è´µå·",
    "06": "æµ·å—"
}

# ç›®æ ‡æ—¥æœŸå’Œæ•°æ®ç±»å‹
TARGET_DATE = "2026-01-12"
DATE_TYPE = "0"  # 0=æ—¥å‰

# è¯»å–JSONæ•°æ®
with open("ç°è´§ä»·æ ¼é‡‡é›†/temp_data.json", "r", encoding="utf-8") as f:
    api_response = json.load(f)

# ä¿å­˜APIå¤‡ä»½
backup_file = f"ç°è´§ä»·æ ¼é‡‡é›†/backups/api_backup_dayahead_{TARGET_DATE.replace('-', '')}.json"
with open(backup_file, "w", encoding="utf-8") as f:
    json.dump(api_response, f, ensure_ascii=False, indent=2)

# æ£€æŸ¥æ•°æ®
data = api_response.get("data", [])
if not data:
    print("âŒ APIè¿”å›ç©ºæ•°æ®")
    exit(1)

# éªŒè¯æ•°æ®å®Œæ•´æ€§
expected_regions = set(REGION_MAP.keys())
actual_regions = {item["exchange"] for item in data}

if expected_regions != actual_regions:
    print(f"âš ï¸ æ•°æ®ä¸å®Œæ•´: æœŸæœ›{len(expected_regions)}ä¸ªåœ°åŒº, å®é™…{len(actual_regions)}ä¸ªåœ°åŒº")
    print(f"ç¼ºå¤±åœ°åŒº: {expected_regions - actual_regions}")

# å‡†å¤‡CSVæ•°æ®
hours = [f"{h:02d}:00" for h in range(24)]
csv_rows = []

# æ ‡é¢˜è¡Œ
header = ["æ—¶é—´"] + [REGION_MAP[code] for code in sorted(REGION_MAP.keys())]
csv_rows.append(header)

# æ•°æ®è¡Œ - æŒ‰å°æ—¶ç»„ç»‡
for hour in range(24):
    hour_str = f"{hour:02d}:00"
    row = [hour_str]

    for region_code in sorted(REGION_MAP.keys()):
        # æ‰¾åˆ°å¯¹åº”åœ°åŒºçš„æ•°æ®
        region_data = next((item for item in data if item["exchange"] == region_code), None)
        if region_data:
            price_key = f"price{hour:02d}00"
            price = region_data.get(price_key, "")
            row.append(price)
        else:
            row.append("")

    csv_rows.append(row)

# ä¿å­˜CSVæ–‡ä»¶
csv_file = f"ç°è´§ä»·æ ¼é‡‡é›†/æ—¥å‰ä»·æ ¼_{TARGET_DATE.replace('-', '')}.csv"
with open(csv_file, "w", encoding="utf-8-sig", newline="") as f:
    writer = csv.writer(f)
    writer.writerows(csv_rows)

# æ•°æ®éªŒè¯
print(f"âœ… é‡‡é›†æˆåŠŸï¼")
print(f"ğŸ“ CSVæ–‡ä»¶: {csv_file}")
print(f"ğŸ’¾ APIå¤‡ä»½: {backup_file}")
print(f"ğŸ“Š æ•°æ®è¡Œæ•°: {len(csv_rows) - 1}è¡Œ")
print(f"ğŸ“ åœ°åŒºæ•°é‡: {len(data)}ä¸ª")
print(f"ğŸ“… è¿è¡Œæ—¥: {TARGET_DATE}")
print(f"ğŸ” æ•°æ®ç±»å‹: æ—¥å‰ä»·æ ¼")

# æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®é¢„è§ˆ
print(f"\næ•°æ®é¢„è§ˆ:")
print(f"{'æ—¶é—´':<8} {header[1]:<12} {header[2]:<12} {header[3]:<12}")
for row in csv_rows[1:6]:
    print(f"{row[0]:<8} {row[1]:<12} {row[2]:<12} {row[3]:<12}")
