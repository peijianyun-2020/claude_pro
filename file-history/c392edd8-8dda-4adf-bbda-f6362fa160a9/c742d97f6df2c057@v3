"""
é£ä¹¦çŸ¥è¯†åº“æ–‡ä»¶ä¸Šä¼ å·¥å…·
æ”¯æŒä¸Šä¼ å•ä¸ªæ–‡ä»¶æˆ–æ•´ä¸ªæ–‡ä»¶å¤¹åˆ°é£ä¹¦çŸ¥è¯†åº“
"""

import os
import json
import requests
from pathlib import Path
from typing import Optional, List
import mimetypes


class FeishuWikiUploader:
    """é£ä¹¦çŸ¥è¯†åº“ä¸Šä¼ å™¨"""

    def __init__(self, app_id: str, app_secret: str, wiki_space_id: Optional[str] = None):
        """
        åˆå§‹åŒ–ä¸Šä¼ å™¨

        Args:
            app_id: é£ä¹¦åº”ç”¨çš„App ID
            app_secret: é£ä¹¦åº”ç”¨çš„App Secret
            wiki_space_id: çŸ¥è¯†åº“ç©ºé—´IDï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªåŠ¨è·å–æ ¹èŠ‚ç‚¹ï¼‰
        """
        self.app_id = app_id
        self.app_secret = app_secret
        self.wiki_space_id = wiki_space_id
        self.tenant_access_token = None
        self.base_url = "https://open.feishu.cn/open-apis"
        self._root_node_token = None

    def get_tenant_access_token(self) -> str:
        """è·å– tenant_access_token"""
        url = f"{self.base_url}/auth/v3/tenant_access_token/internal"
        payload = {
            "app_id": self.app_id,
            "app_secret": self.app_secret
        }

        response = requests.post(url, json=payload)
        data = response.json()

        if data.get("code") != 0:
            raise Exception(f"è·å–tokenå¤±è´¥: {data.get('msg')}")

        self.tenant_access_token = data.get("tenant_access_token")
        return self.tenant_access_token

    def get_wiki_root_node(self) -> str:
        """
        è·å–çŸ¥è¯†åº“çš„æ ¹èŠ‚ç‚¹token

        Returns:
            æ ¹èŠ‚ç‚¹token
        """
        if not self.wiki_space_id:
            raise ValueError("æœªé…ç½® wiki_space_idï¼Œæ— æ³•è·å–æ ¹èŠ‚ç‚¹")

        if not self.tenant_access_token:
            self.get_tenant_access_token()

        # è·å–çŸ¥è¯†åº“èŠ‚ç‚¹åˆ—è¡¨
        url = f"{self.base_url}/wiki/v2/spaces/{self.wiki_space_id}/nodes"
        headers = {
            "Authorization": f"Bearer {self.tenant_access_token}"
        }
        params = {
            "page_size": 10
        }

        response = requests.get(url, headers=headers, params=params)
        result = response.json()

        if result.get("code") != 0:
            raise Exception(f"è·å–çŸ¥è¯†åº“èŠ‚ç‚¹å¤±è´¥: {result.get('msg')}")

        # è·å–ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯é¦–é¡µæˆ–é¡¶å±‚èŠ‚ç‚¹ï¼‰
        items = result.get("data", {}).get("items", [])
        if not items:
            # å¦‚æœçŸ¥è¯†åº“ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œå°†ç›´æ¥åœ¨ç©ºé—´ä¸‹åˆ›å»º
            return ""

        # è¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ token
        self._root_node_token = items[0].get("node_token")
        return self._root_node_token

    def upload_file(self, file_path: str, parent_node_token: Optional[str] = None) -> dict:
        """
        ä¸Šä¼ æ–‡ä»¶åˆ°çŸ¥è¯†åº“

        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            parent_node_token: çˆ¶èŠ‚ç‚¹tokenï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ä½¿ç”¨çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹ï¼‰

        Returns:
            ä¸Šä¼ ç»“æœ
        """
        if not self.tenant_access_token:
            self.get_tenant_access_token()

        # å¦‚æœæ²¡æœ‰æä¾› parent_node_tokenï¼Œè‡ªåŠ¨è·å–çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹
        if not parent_node_token:
            if not self.wiki_space_id:
                raise ValueError("å¿…é¡»æä¾› parent_node_token æˆ–é…ç½® wiki_space_id")
            parent_node_token = self.get_wiki_root_node()
            print(f"ğŸ“ ä½¿ç”¨çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹: {parent_node_token if parent_node_token else '(æ ¹ç›®å½•)'}")

        file_path = Path(file_path)
        if not file_path.exists():
            raise FileNotFoundError(f"æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")

        # è¯»å–æ–‡ä»¶å†…å®¹
        with open(file_path, 'rb') as f:
            file_content = f.read()

        # è·å–æ–‡ä»¶MIMEç±»å‹
        mime_type, _ = mimetypes.guess_type(file_path.name)
        if mime_type is None:
            mime_type = 'application/octet-stream'

        # ä¸Šä¼ æ–‡ä»¶åˆ°äº‘ç©ºé—´
        upload_url = f"{self.base_url}/drive/v1/medias/upload_all"
        headers = {
            "Authorization": f"Bearer {self.tenant_access_token}"
        }

        files = {
            'file': (file_path.name, file_content, mime_type)
        }
        data = {
            "file_type": "file",
            "parent_type": "wiki"
        }

        response = requests.post(upload_url, headers=headers, files=files, data=data)
        result = response.json()

        if result.get("code") != 0:
            raise Exception(f"ä¸Šä¼ æ–‡ä»¶å¤±è´¥: {result.get('msg')}")

        file_token = result.get("data", {}).get("file_token")

        # åˆ›å»ºçŸ¥è¯†åº“æ–‡æ¡£èŠ‚ç‚¹
        return self.create_wiki_node(
            parent_node_token=parent_node_token,
            obj_type="file",
            title=file_path.name,
            file_token=file_token
        )

    def create_wiki_node(self, parent_node_token: str, obj_type: str,
                        title: str, file_token: Optional[str] = None) -> dict:
        """
        åˆ›å»ºçŸ¥è¯†åº“èŠ‚ç‚¹

        Args:
            parent_node_token: çˆ¶èŠ‚ç‚¹token
            obj_type: èŠ‚ç‚¹ç±»å‹ (file/doc/sheetç­‰)
            title: èŠ‚ç‚¹æ ‡é¢˜
            file_token: æ–‡ä»¶tokenï¼ˆå¦‚æœæ˜¯æ–‡ä»¶ç±»å‹ï¼‰

        Returns:
            åˆ›å»ºç»“æœ
        """
        if not self.tenant_access_token:
            self.get_tenant_access_token()

        url = f"{self.base_url}/wiki/v2/spaces/*/nodes"
        headers = {
            "Authorization": f"Bearer {self.tenant_access_token}",
            "Content-Type": "application/json"
        }

        payload = {
            "parent_node_token": parent_node_token,
            "obj_type": obj_type,
            "title": title
        }

        if file_token:
            payload["file_token"] = file_token

        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if result.get("code") != 0:
            raise Exception(f"åˆ›å»ºçŸ¥è¯†åº“èŠ‚ç‚¹å¤±è´¥: {result.get('msg')}")

        return result

    def upload_folder(self, folder_path: str, parent_node_token: Optional[str] = None,
                     recursive: bool = True) -> List[dict]:
        """
        ä¸Šä¼ æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶

        Args:
            folder_path: æ–‡ä»¶å¤¹è·¯å¾„
            parent_node_token: çˆ¶èŠ‚ç‚¹tokenï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ä½¿ç”¨çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹ï¼‰
            recursive: æ˜¯å¦é€’å½’ä¸Šä¼ å­æ–‡ä»¶å¤¹

        Returns:
            ä¸Šä¼ ç»“æœåˆ—è¡¨
        """
        if not self.tenant_access_token:
            self.get_tenant_access_token()

        # å¦‚æœæ²¡æœ‰æä¾› parent_node_tokenï¼Œè‡ªåŠ¨è·å–çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹
        if not parent_node_token:
            if not self.wiki_space_id:
                raise ValueError("å¿…é¡»æä¾› parent_node_token æˆ–é…ç½® wiki_space_id")
            parent_node_token = self.get_wiki_root_node()
            print(f"ğŸ“ ä½¿ç”¨çŸ¥è¯†åº“æ ¹èŠ‚ç‚¹: {parent_node_token if parent_node_token else '(æ ¹ç›®å½•)'}")

        folder_path = Path(folder_path)
        if not folder_path.exists() or not folder_path.is_dir():
            raise NotADirectoryError(f"æ–‡ä»¶å¤¹ä¸å­˜åœ¨: {folder_path}")

        results = []

        # è·å–æ‰€æœ‰æ–‡ä»¶
        if recursive:
            files = list(folder_path.rglob("*"))
        else:
            files = list(folder_path.glob("*"))

        for file_path in files:
            if file_path.is_file():
                try:
                    result = self.upload_file(str(file_path), parent_node_token)
                    results.append({
                        "file": str(file_path),
                        "status": "success",
                        "result": result
                    })
                    print(f"âœ“ ä¸Šä¼ æˆåŠŸ: {file_path.name}")
                except Exception as e:
                    results.append({
                        "file": str(file_path),
                        "status": "failed",
                        "error": str(e)
                    })
                    print(f"âœ— ä¸Šä¼ å¤±è´¥: {file_path.name} - {str(e)}")

        return results


def main():
    """ç¤ºä¾‹ç”¨æ³•"""
    # ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è¯»å–
    app_id = os.getenv("FEISHU_APP_ID", "your_app_id")
    app_secret = os.getenv("FEISHU_APP_SECRET", "your_app_secret")
    wiki_space_id = os.getenv("FEISHU_WIKI_SPACE_ID", "your_wiki_space_id")
    parent_node_token = os.getenv("FEISHU_WIKI_NODE_TOKEN", None)  # å¯é€‰

    uploader = FeishuWikiUploader(app_id, app_secret, wiki_space_id)

    # ç¤ºä¾‹1: ä¸Šä¼ å•ä¸ªæ–‡ä»¶ï¼ˆè‡ªåŠ¨ä½¿ç”¨æ ¹èŠ‚ç‚¹ï¼‰
    # result = uploader.upload_file("æ•°æ®æ–‡æ¡£/20260114æ—¥å‰.xlsx")

    # ç¤ºä¾‹2: ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶å¤¹ï¼ˆè‡ªåŠ¨ä½¿ç”¨æ ¹èŠ‚ç‚¹ï¼‰
    # results = uploader.upload_folder("æ•°æ®æ–‡æ¡£")

    # ç¤ºä¾‹3: ä¸Šä¼ åˆ°æŒ‡å®šèŠ‚ç‚¹
    # result = uploader.upload_file("æ•°æ®æ–‡æ¡£/20260114æ—¥å‰.xlsx", parent_node_token)


if __name__ == "__main__":
    main()
